<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>SubÃ­ tu foto</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#000;
  color:#fff;
  font-family:system-ui;
}
form{
  width:90%;
  max-width:420px;
  display:flex;
  flex-direction:column;
  gap:14px;
}
input,button{
  padding:14px;
  font-size:18px;
  border-radius:10px;
  border:none;
}
button{
  background:#00c2ff;
  font-weight:700;
}
progress{
  width:100%;
  height:20px;
}
#ok{
  display:none;
  text-align:center;
  font-size:20px;
  margin-top:20px;
}
</style>
</head>

<body>

<form id="f">
  <input id="nombre" placeholder="Tu nombre" required>
  <input id="mensaje" placeholder="Mensaje (No uses EMOJIS o no se verÃ¡ la foto!)">
  <input id="foto" type="file" accept="image/*" required>
  <progress id="bar" value="0" max="100"></progress>
  <button>Subir foto ðŸ“¸</button>
  <div id="ok">âœ… Â¡Listo! Ahora mirÃ¡ la pantalla ðŸ‘€</div>
</form>

<script>
const CLOUD = "craneosuy";
const PRESET = "evento_unsigned";
const WORKER = "https://evento-foto.pablocerrutti.workers.dev";

f.onsubmit = e => {
  e.preventDefault();

  const n = nombre.value.trim().replace(/\s+/g,"_");
  const m = mensaje.value.trim().replace(/\s+/g,"_");

  const fd = new FormData();
  fd.append("file", foto.files[0]);
  fd.append("upload_preset", PRESET);
  fd.append("public_id", `evento___${n}___${m}`);

  const xhr = new XMLHttpRequest();
  xhr.open("POST", `https://api.cloudinary.com/v1_1/${CLOUD}/image/upload`);

  xhr.upload.onprogress = ev => {
    if(ev.lengthComputable){
      bar.value = (ev.loaded / ev.total) * 100;
    }
  };

  xhr.onload = async () => {
    const data = JSON.parse(xhr.responseText);

    await fetch(WORKER + "/add", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        url: data.secure_url,
        public_id: data.public_id
      })
    });

    bar.value = 100;
    ok.style.display = "block";
    f.reset();
  };

  xhr.send(fd);
};
</script>

</body>
</html>
