<script>
const CLOUD_NAME = "craneosuy";
const UPLOAD_PRESET = "evento_unsigned";

const btn = document.getElementById("btn");
const estado = document.getElementById("estado");
const foto = document.getElementById("foto");
const nombreInput = document.getElementById("nombre");
const mensajeInput = document.getElementById("mensaje");

function limpiar(texto, esNombre=false) {
  if (!texto.trim()) return esNombre ? "anonimo" : "";
  return texto.normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-zA-Z0-9 _-]/g, "")
    .trim();
}

btn.onclick = async () => {
  const file = foto.files[0];
  if (!file || !nombreInput.value.trim()) {
    estado.textContent = "⚠️ Foto y nombre obligatorios";
    return;
  }

  btn.disabled = true;
  estado.textContent = "Subiendo foto… ⏳";

  const nombre = limpiar(nombreInput.value, true);
  const mensaje = limpiar(mensajeInput.value);
  const publicId = `${nombre}___${mensaje}___${Date.now()}`;

  try {
    const fd = new FormData();
    fd.append("file", file);
    fd.append("upload_preset", UPLOAD_PRESET);
    fd.append("public_id", publicId);
    fd.append("folder", "evento-qr");

    const res = await fetch(
      `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,
      { method: "POST", body: fd }
    );

    const data = await res.json();
    if (!res.ok) throw data;

    estado.textContent = "✅ Foto subida correctamente, mirá la pantalla!";
    foto.value = "";
    mensajeInput.value = "";

  } catch (e) {
    console.error(e);
    estado.textContent = "❌ Error al subir la foto";
  }

  btn.disabled = false;
};
</script>
