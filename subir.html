<!DOCTYPE html> 
<html lang="es"> 
  <head> <meta charset="UTF-8"> 
    <title>Sub√≠ tu foto</title> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <style> 
      body 
      { margin: 0; 
       min-height: 100vh; 
       background: radial-gradient(circle at top, #111, #000); 
       color: #fff; 
       font-family: system-ui, sans-serif; 
       display: flex; 
       justify-content: center; 
       align-items: center;
      } 
      .card { background: #0e0e0e; 
             padding: 28px; 
             border-radius: 20px; 
             width: 100%; 
             max-width: 420px; 
             box-shadow: 0 20px 60px rgba(0,0,0,.7); 
             text-align: center;
            } 
      img { 
        width: 180px; 
        margin-bottom: 16px;
      }
    h1 { 
      font-size: 22px; 
      margin-bottom: 14px;
    }
input, textarea, button { 
  width: 100%; 
  margin-top: 12px; 
  padding: 14px; 
  border-radius: 12px; 
  border: none; 
  font-size: 16px; 
  box-sizing: border-box;
}  
input, textarea { 
  background: #1a1a1a; 
  color: #fff;
} 
textarea { 
  resize: none; 
  height: 80px; 
} 
button { 
  background: linear-gradient(135deg, #00c853, #2979ff); 
  color: #fff; 
  font-weight: 700; 
  cursor: pointer; 
} 
button:disabled { 
  opacity: .5;
} 
.estado { 
  margin-top: 14px; 
  min-height: 20px;
} 
    </style> 
  </head> 
  <body> 
    <div class="card"> 
      <img src="logo.png" alt="Logo"> 
      <h1>Sub√≠ tu foto al evento üì∏</h1> 
      <input type="file" id="foto" accept="image/*"> 
      <input type="text" id="nombre" placeholder="Tu nombre"> 
      <textarea id="mensaje" placeholder="Mensaje (opcional)"></textarea> 
      <button id="btn">Subir foto</button> 
      <div class="estado" id="estado"></div>
</div>
  
<script>
const CLOUD_NAME = "craneosuy";
const UPLOAD_PRESET = "evento_unsigned";

const GH_OWNER = "mynmzhtz5h-svg";
const GH_REPO  = "pantalla_evento";
const GH_BRANCH = "main";
const GH_TOKEN = "PEG√Å_AC√Å_TU_TOKEN_VALIDO"; // cl√°sico token con repo

const btn = document.getElementById("btn");
const estado = document.getElementById("estado");
const foto = document.getElementById("foto");
const nombreInput = document.getElementById("nombre");
const mensajeInput = document.getElementById("mensaje");

function limpiar(t, nombre=false){
  if (!t.trim()) return nombre ? "anonimo" : "";
  return t.normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-zA-Z0-9 _-]/g, "")
    .trim();
}

btn.onclick = async () => {
  if (!foto.files.length || !nombreInput.value.trim()) {
    estado.textContent = "‚ö†Ô∏è Foto y nombre obligatorios";
    return;
  }

  btn.disabled = true;
  estado.textContent = "Subiendo foto‚Ä¶ ‚è≥";

  try {
    /* 1Ô∏è‚É£ SUBIR IMAGEN */
    const nombre = limpiar(nombreInput.value, true);
    const mensaje = limpiar(mensajeInput.value);
    const publicId = `${nombre}___${mensaje}___${Date.now()}`;

    const fd = new FormData();
    fd.append("file", foto.files[0]);
    fd.append("upload_preset", UPLOAD_PRESET);
    fd.append("folder", "evento-qr");
    fd.append("public_id", publicId);

    const up = await fetch(
      `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,
      { method: "POST", body: fd }
    );
    const img = await up.json();
    if (!up.ok) throw img;

    /* 2Ô∏è‚É£ LEER fotos.json */
    let fotos = [];
    try {
      const r = await fetch(
        `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}/fotos.json?${Date.now()}`
      );
      fotos = await r.json();
      if (!Array.isArray(fotos)) fotos = [];
    } catch {}

    /* 3Ô∏è‚É£ AGREGAR FOTO */
    fotos.unshift({
      img: img.secure_url,
      nombre,
      mensaje
    });

    /* 4Ô∏è‚É£ OBTENER SHA */
    const shaResp = await fetch(
      `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/fotos.json`,
      { headers: { Authorization: `token ${GH_TOKEN}` } }
    );
    const shaData = await shaResp.json();

    /* 5Ô∏è‚É£ GUARDAR fotos.json */
    const save = await fetch(
      `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/fotos.json`,
      {
        method: "PUT",
        headers: {
          Authorization: `token ${GH_TOKEN}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "foto evento",
          content: btoa(
            unescape(encodeURIComponent(JSON.stringify(fotos, null, 2)))
          ),
          sha: shaData.sha,
          branch: GH_BRANCH
        })
      }
    );

    if (!save.ok) throw await save.json();

    estado.textContent = "‚úÖ Foto subida, mir√° la pantalla!";
    foto.value = "";
    mensajeInput.value = "";

  } catch (e) {
    console.error(e);
    estado.textContent = "‚ùå Error al subir la foto";
  }

  btn.disabled = false;
};
</script>
