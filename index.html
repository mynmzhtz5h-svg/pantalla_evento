<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pantalla Evento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at center, #222 0%, #000 70%);
  font-family: system-ui, sans-serif;
  overflow: hidden;
}

#escenario {
  position: relative;
  width: 100%;
  height: 100%;
}

/* LOGO */
#logo {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: 220px;
  z-index: 10;
}

/* CONTENEDOR DEL QR + MENSAJE INICIAL */
#qr-container {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 1s ease;
  z-index: 5;
  cursor: pointer;
}

#qr-container.chico {
  position: absolute;
  bottom: 20px;
  right: 20px;
  width: 140px;
  height: 140px;
  transform: none;
}

#qr-container img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 16px;
}

#qr-texto {
  margin-top: 16px;
  text-align: center;
  font-size: 22px;
  font-weight: 600;
  color: #fff;
  text-shadow: 0 0 8px #000;
}

/* CONTENEDOR DEL CARRUSEL */
#carrusel-contenedor {
  position: absolute;
  top: 100px;
  left: 0;
  right: 0;
  bottom: 60px;
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1;
}

#carrusel {
  width: 90%;
  height: 90%;
  position: relative;
}

#carrusel img {
  position: absolute;
  width: 100%;
  height: 100%;
  object-fit: contain;
  opacity: 0;
  transition: opacity 1s ease;
}

#carrusel img.activa {
  opacity: 1;
}

/* INFO FOTO */
#info {
  position: absolute;
  left: 40px;
  bottom: 40px;
  max-width: 40%;
  padding: 24px;
  border-radius: 18px;
  background: linear-gradient(135deg, #00ffcc, #0066ff);
  color: #000;
  font-size: 20px;
  box-shadow: 0 20px 40px rgba(0,0,0,.5);
  animation: glow 6s infinite alternate;
}

@keyframes glow {
  from { filter: hue-rotate(0deg) }
  to { filter: hue-rotate(60deg) }
}
</style>
</head>

<body>
<div id="escenario">
  <img id="logo" src="logo.png" alt="Logo">

  <!-- QR + MENSAJE -->
  <a id="qr-container" href="https://mynmzhtz5h-svg.github.io/subida-fotos-evento/" target="_blank">
    <img src="qr.png" alt="QR">
    <div id="qr-texto">Escanea, subí tu foto y sé parte de la fiesta!</div>
  </a>

  <div id="carrusel-contenedor">
    <div id="carrusel"></div>
    <div id="info"></div>
  </div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://mjmbvzvirvtsihtyrqqf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qbWJ2enZpcnZ0c2lodHlycXFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NDk2ODUsImV4cCI6MjA4NTIyNTY4NX0.ZHo3Tsi2GwJFvW3iwOKBQ6c_6KhHx2Ju8wUrU223zkU"
);

const carrusel = document.getElementById("carrusel");
const info = document.getElementById("info");
const qrContainer = document.getElementById("qr-container");
let fotos = [];
let i = 0;

async function cargarFotos() {
  const { data, error } = await supabase.storage.from("evento").list("", {limit: 100, offset:0});
  if(error) {
    console.error("Error cargando fotos:", error);
    return [];
  }
  // filtrar solo jpg, png, jpeg
  return data.filter(f => /\.(jpe?g|png)$/i.test(f.name)).sort((a,b) => b.created_at - a.created_at);
}

function crearImg(f) {
  const img = document.createElement("img");
  img.src = `https://mjmbvzvirvtsihtyrqqf.supabase.co/storage/v1/object/public/evento/${encodeURIComponent(f.name)}`;
  return img;
}

function mostrarQRGrande() {
  qrContainer.classList.remove("chico");
  qrContainer.style.transition = "all 1s";
}

function moverQRChico() {
  qrContainer.classList.add("chico");
}

async function iniciarCarrusel() {
  if(fotos.length === 0) {
    mostrarQRGrande();
    return;
  }

  // mover QR al angulo inferior derecho
  moverQRChico();

  carrusel.innerHTML = "";
  info.innerHTML = "";
  i = 0;

  fotos.forEach(f => {
    const img = crearImg(f);
    carrusel.appendChild(img);
  });

  while(true) {
    const imagenes = Array.from(carrusel.querySelectorAll("img"));
    if(imagenes.length === 0) {
      mostrarQRGrande();
      await new Promise(r=>setTimeout(r,10000));
      fotos = await cargarFotos();
      continue;
    }

    const img = imagenes[i];
    imagenes.forEach(im => im.classList.remove("activa"));
    img.classList.add("activa");

    // info foto
    const partes = img.src.split("/").pop().split("___");
    const nombre = partes[0]?.replace(/_/g," ");
    const mensaje = partes[1]?.replace(/_/g," ");
    info.innerHTML = `<strong>${nombre}</strong><br>${mensaje}`;

    await new Promise(r=>setTimeout(r,10000));
    i = (i+1)%imagenes.length;

    if(i===0) {
      // vuelta a QR grande
      mostrarQRGrande();
      await new Promise(r=>setTimeout(r,10000));
      fotos = await cargarFotos(); // actualizar nuevas fotos
      if(fotos.length===0) continue;
      moverQRChico();
    }
  }
}

// loop inicial
(async function loop() {
  fotos = await cargarFotos();
  if(fotos.length===0){
    mostrarQRGrande();
  }
  setInterval(async ()=>{
    const nuevas = await cargarFotos();
    if(nuevas.length>fotos.length) fotos = nuevas; // añadir al inicio
  },10000);

  await new Promise(r=>setTimeout(r,10000)); // mostrar QR inicial 10s
  iniciarCarrusel();
})();
</script>

</body>
</html>
