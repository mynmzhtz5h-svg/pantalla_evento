<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pantalla Evento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body {
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background: radial-gradient(circle at center, #222 0%, #000 70%);
  font-family: system-ui, sans-serif;
  overflow:hidden;
}

/* LOGO */
#logo {
  position:absolute;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  width:220px;
  z-index:10;
}

/* QR + TEXTO INICIAL */
#qr-container {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  width: 300px;
  height: 300px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  transition: all 1s ease;
  z-index:9;
  text-align:center;
}
#qr-container.chico {
  position:absolute;
  left:40px;
  bottom:40px;
  max-width:40%;
  padding:20px;
  border-radius:16px;
  transform:none;
}
#qr-container img {
  width:100%;
  height:100%;
  object-fit:contain;
  border-radius:12px;
}
#qr-texto {
  margin-top:12px;
  color:#fff;
  font-size:18px;
  font-weight:600;
  text-shadow: 0 0 8px #000;
}

/* CARRUSEL */
#carrusel-contenedor {
  position:absolute;
  top:100px;
  left:0;
  right:0;
  bottom:60px;
  display:flex;
  justify-content:center;
  align-items:center;
  overflow:hidden;
  z-index:1;
}
#carrusel {
  width:90%;
  height:90%;
  position:relative;
}
#carrusel img {
  position:absolute;
  width:100%;
  height:100%;
  object-fit:contain;
  opacity:0;
  transition: opacity 1s ease;
}
#carrusel img.activa {
  opacity:1;
}

/* INFO FOTO */
#info {
  position:absolute;
  left:40px;
  bottom:40px;
  max-width:40%;
  padding:20px;
  border-radius:16px;
  background: linear-gradient(135deg, #00ffcc, #0066ff);
  color:#000;
  font-size:20px;
  z-index:2;
  box-shadow:0 10px 30px rgba(0,0,0,.5);
}
</style>
</head>

<body>
<img id="logo" src="logo.png" alt="Logo">

<a id="qr-container" href="https://mynmzhtz5h-svg.github.io/subida-fotos-evento/" target="_blank">
  <img src="qr.png" alt="QR">
  <div id="qr-texto">Escanea, subí tu foto y sé parte de la fiesta!</div>
</a>

<div id="carrusel-contenedor">
  <div id="carrusel"></div>
  <div id="info"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://mjmbvzvirvtsihtyrqqf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qbWJ2enZpcnZ0c2lodHlycXFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NDk2ODUsImV4cCI6MjA4NTIyNTY4NX0.ZHo3Tsi2GwJFvW3iwOKBQ6c_6KhHx2Ju8wUrU223zkU"
);

const carrusel = document.getElementById("carrusel");
const info = document.getElementById("info");
const qrContainer = document.getElementById("qr-container");

let fotos = [];
let i = 0;

async function cargarFotos() {
  const { data, error } = await supabase.storage.from("evento").list("", {limit:100, offset:0});
  if(error) return [];
  return data.filter(f => /\.(jpe?g|png)$/i.test(f.name)).sort((a,b)=>b.created_at - a.created_at);
}

function crearImg(f){
  const img = document.createElement("img");
  img.src = `https://mjmbvzvirvtsihtyrqqf.supabase.co/storage/v1/object/public/evento/${encodeURIComponent(f.name)}`;
  return img;
}

function mostrarQRGrande() {
  qrContainer.classList.remove("chico");
  qrContainer.querySelector("#qr-texto").textContent = "Escanea, subí tu foto y sé parte de la fiesta!";
}

function moverQRChico() {
  qrContainer.classList.add("chico");
  qrContainer.querySelector("#qr-texto").textContent = "Escanea para participar";
}

async function iniciarCarrusel() {
  if(fotos.length === 0) {
    mostrarQRGrande();
    return;
  }

  moverQRChico();

  carrusel.innerHTML = "";
  info.innerHTML = "";
  i = 0;

  fotos.forEach(f => carrusel.appendChild(crearImg(f)));

  while(true){
    const imagenes = Array.from(carrusel.querySelectorAll("img"));
    if(imagenes.length===0){
      mostrarQRGrande();
      await new Promise(r=>setTimeout(r,10000));
      fotos = await cargarFotos();
      continue;
    }

    const img = imagenes[i];
    imagenes.forEach(im=>im.classList.remove("activa"));
    img.classList.add("activa");

    // info foto
    const partes = img.src.split("/").pop().split("___");
    const nombre = partes[0]?.replace(/_/g," ");
    const mensaje = partes[1]?.replace(/_/g," ");
    info.innerHTML = `<strong>${nombre}</strong><br>${mensaje}`;

    await new Promise(r=>setTimeout(r,10000));
    i++;

    if(i>=imagenes.length){
      // fade out a negro y mostrar QR inicial
      imagenes.forEach(im=>im.classList.remove("activa"));
      info.innerHTML = "";
      mostrarQRGrande();
      await new Promise(r=>setTimeout(r,10000));
      fotos = await cargarFotos();
      if(fotos.length>0) moverQRChico();
      i=0;
    }
  }
}

(async function loop(){
  fotos = await cargarFotos();
  if(fotos.length===0) mostrarQRGrande();

  // chequeo de nuevas fotos cada 10s
  setInterval(async ()=>{
    const nuevas = await cargarFotos();
    if(nuevas.length>fotos.length) fotos = nuevas;
  },10000);

  // espera 10s inicial
  await new Promise(r=>setTimeout(r,10000));
  iniciarCarrusel();
})();
</script>
</body>
</html>
