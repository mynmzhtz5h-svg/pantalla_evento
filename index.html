<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Evento en Vivo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  background: radial-gradient(circle at top, #111, #000);
  color: #fff;
  font-family: system-ui, sans-serif;
  overflow: hidden;
}

/* CONTENEDOR GENERAL */
#app {
  position: relative;
  width: 100vw;
  height: 100vh;
}

/* LOGO */
#logo {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
}
#logo img {
  height: 80px;
}

/* QR GRANDE */
#qrScreen {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
  text-align: center;
}

#qrScreen img {
  width: 320px;
}

#qrScreen h1 {
  font-size: 32px;
}

/* CARRUSEL */
#carousel {
  position: absolute;
  inset: 0;
  display: none;
}

.slide {
  position: absolute;
  inset: 0;
  opacity: 0;
  transition: opacity 1s ease;
}

.slide.active {
  opacity: 1;
}

.slide img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* INFO FOTO */
.infoBox {
  position: absolute;
  left: 40px;
  top: 50%;
  transform: translateY(-50%);
  padding: 20px 26px;
  border-radius: 18px;
  max-width: 35%;
  animation: colorShift 8s linear infinite;
}

@keyframes colorShift {
  0% { background: rgba(0,150,136,.85); }
  50% { background: rgba(33,150,243,.85); }
  100% { background: rgba(156,39,176,.85); }
}

.infoBox h2 {
  margin: 0 0 8px;
}

/* QR PEQUE√ëO */
#qrCorner {
  position: absolute;
  right: 20px;
  bottom: 20px;
  text-align: center;
  display: none;
}

#qrCorner img {
  width: 120px;
}

#qrCorner p {
  margin-top: 8px;
  font-weight: 700;
}
</style>
</head>

<body>
<div id="app">

  <div id="logo">
    <img src="logo.png">
  </div>

  <!-- QR INICIAL -->
  <div id="qrScreen">
    <img src="qr.png">
    <h1>Escane√° y sub√≠ tu foto üì∏</h1>
  </div>

  <!-- CARRUSEL -->
  <div id="carousel"></div>

  <!-- QR CHICO -->
  <div id="qrCorner">
    <img src="qr.png">
    <p>SUB√ç TU FOTO Y S√â PARTE DE LA FIESTA!</p>
  </div>

</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://mjmbvzvirvtsihtyrqqf.supabase.co",
  "PUBLIC_ANON_KEY"
);

const qrScreen = document.getElementById("qrScreen");
const carousel = document.getElementById("carousel");
const qrCorner = document.getElementById("qrCorner");

let slides = [];
let index = 0;
let started = false;

/* CARGA FOTOS */
async function loadPhotos() {
  const { data } = await supabase.storage.from("evento").list("", {
    limit: 100,
    sortBy: { column: "created_at", order: "desc" }
  });

  const images = (data || []).filter(f =>
    /\.(jpg|jpeg|png)$/i.test(f.name)
  );

  if (!images.length) {
    // NO HAY FOTOS ‚Üí QR PERMANENTE
    started = false;
    carousel.style.display = "none";
    qrCorner.style.display = "none";
    qrScreen.style.display = "flex";
    return;
  }

  if (!started) {
    started = true;
    startCarousel(images);
  }
}

/* INICIAR CARRUSEL */
function startCarousel(images) {
  carousel.innerHTML = "";
  slides = images.map(f => {
    const url = supabase.storage.from("evento").getPublicUrl(f.name).data.publicUrl;

    const slide = document.createElement("div");
    slide.className = "slide";

    slide.innerHTML = `
      <img src="${url}">
      <div class="infoBox">
        <h2>${f.name.split("___")[0].replaceAll("_"," ")}</h2>
        <p>${(f.name.split("___")[1]||"").replaceAll("_"," ")}</p>
      </div>
    `;
    carousel.appendChild(slide);
    return slide;
  });

  qrScreen.style.display = "none";
  carousel.style.display = "block";

  // QR GRANDE 10s AL INICIO
  setTimeout(() => {
    qrCorner.style.display = "block";
    showSlide(0);
  }, 10000);
}

/* MOSTRAR SLIDE */
function showSlide(i) {
  slides.forEach(s => s.classList.remove("active"));
  slides[i].classList.add("active");

  setTimeout(() => {
    index = (i + 1) % slides.length;

    if (index === 0) {
      // FIN ‚Üí QR GRANDE
      carousel.style.display = "none";
      qrCorner.style.display = "none";
      qrScreen.style.display = "flex";
      setTimeout(() => {
        carousel.style.display = "block";
        qrCorner.style.display = "block";
        showSlide(0);
      }, 10000);
    } else {
      showSlide(index);
    }
  }, 8000);
}

/* BUSCAR NUEVAS FOTOS */
setInterval(loadPhotos, 10000);
loadPhotos();
</script>

</body>
</html>
