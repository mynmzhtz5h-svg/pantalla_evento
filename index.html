<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pantalla Evento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html,body{
  margin:0;height:100%;
  background:radial-gradient(circle,#222,#000);
  font-family:system-ui;
  overflow:hidden;
}
#branding{position:absolute;top:20px;left:50%;transform:translateX(-50%);z-index:10}
#branding img{width:200px}

#carousel{
  position:absolute;top:160px;left:50%;
  transform:translateX(-50%);
  width:90%;height:65vh;
  display:flex;justify-content:center;align-items:center
}

.slide{
  position:absolute;
  max-width:100%;max-height:100%;
  opacity:0;
  transition:opacity 1.5s;
  border-radius:20px;
  box-shadow:0 20px 60px rgba(0,0,0,.6)
}
.slide.activa{opacity:1}

#qr{
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%);
  text-align:center;
  transition:all .8s
}
#qr.chico{
  left:auto;right:30px;top:50%;
  transform:translateY(-50%);
  width:140px
}
#qr img{width:60%;border-radius:20px}
#qr div{margin-top:12px;color:#fff;font-size:20px;font-weight:600}

#autor{
  position:absolute;
  left:40px;
  top:50%;
  transform:translateY(-50%);
  max-width:30%;
  color:#fff;
  display:none;
}
#autor span{
  display:block;
}
#nombre{
  font-size:26px;
  font-weight:700;
  margin-bottom:10px;
}
#mensaje{
  font-size:22px;
  font-weight:400;
}
</style>
</head>

<body>

<div id="branding"><img src="logo.png"></div>
<div id="carousel"></div>

<div id="qr">
  <img src="qr.png">
  <div>EscaneÃ¡ y subÃ­ tu foto ðŸ“¸</div>
</div>

<div id="autor">
  <span id="nombre"></span>
  <span id="mensaje"></span>
</div>

<script>
const WORKER = "https://evento-foto.pablocerrutti.workers.dev";

const carousel = document.getElementById("carousel");
const qr = document.getElementById("qr");
const autor = document.getElementById("autor");
const nombre = document.getElementById("nombre");
const mensaje = document.getElementById("mensaje");

let fotos = [];
let index = 0;
let mostrando = false;

/* ======================
   CARGAR FOTOS (sin duplicar)
====================== */
async function cargarFotos(){
  try{
    const r = await fetch(WORKER + "/list?ts=" + Date.now());
    const data = await r.json();
    if(!Array.isArray(data)) return;

    const existentes = new Set(fotos.map(f => f.public_id));
    const nuevas = data.filter(f => !existentes.has(f.public_id));

    if(nuevas.length){
      fotos = [...nuevas, ...fotos];
    }
  }catch(e){}
}

/* ======================
   MOSTRAR QR
====================== */
function mostrarQR(){
  mostrando = false;
  carousel.innerHTML = "";
  autor.style.display = "none";
  qr.classList.remove("chico");

  setTimeout(async ()=>{
    await cargarFotos();
    if(fotos.length){
      index = 0;
      mostrarFoto();
    }else{
      mostrarQR();
    }
  }, 8000);
}

/* ======================
   MOSTRAR FOTO
====================== */
function mostrarFoto(){
  if(!fotos.length){
    return mostrarQR();
  }

  mostrando = true;
  qr.classList.add("chico");

  const f = fotos[index];

  const img = document.createElement("img");
  img.src = f.url;
  img.className = "slide";
  carousel.appendChild(img);

  requestAnimationFrame(()=>img.classList.add("activa"));

  while(carousel.children.length > 2){
    carousel.children[0].remove();
  }

  const partes = (f.public_id || "").split("___");
  nombre.textContent = (partes[1] || "").replace(/_/g," ");
  mensaje.textContent = (partes[2] || "").replace(/_/g," ");

  autor.style.display = "block";

  index++;

  if(index >= fotos.length){
    setTimeout(mostrarQR, 8000);
  }else{
    setTimeout(mostrarFoto, 8000);
  }
}

/* ======================
   REFRESCO SILENCIOSO
====================== */
setInterval(()=>{
  if(!mostrando){
    cargarFotos();
  }
}, 7000);

/* ======================
   ARRANQUE
====================== */
mostrarQR();
</script>

</body>
</html>
