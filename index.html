<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pantalla Evento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    margin: 0;
    background: black;
    color: white;
    font-family: system-ui, sans-serif;
    overflow: hidden;
  }

  #branding {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
  }

  #branding img {
    width: 180px;
  }

  #inicio {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 24px;
    text-align: center;
    z-index: 5;
  }

  #inicio img {
    width: 320px;
    background: white;
    padding: 18px;
    border-radius: 20px;
  }

  #inicio p {
    font-size: 22px;
  }

  #escenario {
    position: absolute;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .slide {
    max-width: 90vw;
    max-height: 80vh;
    opacity: 0;
    transition: opacity 1.2s ease;
    position: absolute;
  }

  .slide.activa {
    opacity: 1;
  }

  #texto {
    position: absolute;
    left: 40px;
    top: 50%;
    transform: translateY(-50%);
    background: linear-gradient(135deg, #00ffaa, #00aaff);
    color: black;
    padding: 18px 22px;
    border-radius: 16px;
    font-size: 22px;
    max-width: 420px;
    display: none;
    z-index: 6;
  }

  #qr-mini {
    position: absolute;
    bottom: 20px;
    right: 20px;
    background: white;
    padding: 10px;
    border-radius: 14px;
    width: 120px;
    display: none;
    z-index: 6;
    text-align: center;
  }

  #qr-mini img {
    width: 100%;
  }

  #qr-mini span {
    font-size: 13px;
    color: black;
    font-weight: 700;
    display: block;
    margin-top: 6px;
  }
</style>
</head>

<body>

<div id="branding">
  <img src="logo.png">
</div>

<div id="inicio">
  <img src="https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=https://mynmzhtz5h-svg.github.io/subida-fotos-evento/">
  <p>Escane√° el QR y sub√≠ tu foto</p>
</div>

<div id="escenario"></div>
<div id="texto"></div>

<div id="qr-mini">
  <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://mynmzhtz5h-svg.github.io/subida-fotos-evento/">
  <span>¬°Sub√≠ tu foto!</span>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://mjmbvzvirvtsihtyrqqf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qbWJ2enZpcnZ0c2lodHlycXFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NDk2ODUsImV4cCI6MjA4NTIyNTY4NX0.ZHo3Tsi2GwJFvW3iwOKBQ6c_6KhHx2Ju8wUrU223zkU"
);

const inicio = document.getElementById("inicio");
const escenario = document.getElementById("escenario");
const texto = document.getElementById("texto");
const qrMini = document.getElementById("qr-mini");

let fotos = [];
let index = 0;
let carruselActivo = false;

async function cargarFotos() {
  const { data } = await supabase.storage.from("evento").list("", {
    sortBy: { column: "created_at", order: "desc" }
  });

  // üî• FILTRO REAL: solo archivos v√°lidos
  fotos = (data || []).filter(f => f.name && f.id);
}

function mostrarQR() {
  inicio.style.display = "flex";
  qrMini.style.display = "none";
  texto.style.display = "none";
  escenario.innerHTML = "";
  carruselActivo = false;
}

function mostrarFoto() {
  if (fotos.length === 0) {
    mostrarQR();
    return;
  }

  inicio.style.display = "none";
  qrMini.style.display = "block";
  carruselActivo = true;

  escenario.innerHTML = "";

  const f = fotos[index];
  const img = document.createElement("img");
  img.src = supabase.storage.from("evento").getPublicUrl(f.name).data.publicUrl;
  img.className = "slide activa";
  escenario.appendChild(img);

  const partes = f.name.split("___");
  const nombre = partes[0]?.replace(/_/g, " ");
  const mensaje = partes[1]?.replace(/_/g, " ");

  texto.innerHTML = `<strong>${nombre}</strong><br>${mensaje || ""}`;
  texto.style.display = "block";

  index = (index + 1) % fotos.length;
}

async function iniciar() {
  await cargarFotos();

  if (fotos.length === 0) {
    mostrarQR();
    return;
  }

  mostrarQR();

  setTimeout(() => {
    mostrarFoto();
    setInterval(mostrarFoto, 8000);
  }, 10000);
}

// Buscar nuevas fotos cada 10s
setInterval(async () => {
  const antes = fotos.length;
  await cargarFotos();

  if (antes === 0 && fotos.length > 0) {
    iniciar();
  }
}, 10000);

iniciar();
</script>

</body>
</html>
