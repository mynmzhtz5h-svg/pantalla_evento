<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pantalla Evento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: #000;
  overflow: hidden;
  font-family: system-ui, sans-serif;
}

#escenario {
  position: absolute;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
}

.slide {
  position: absolute;
  width: 100%;
  height: 100%;
  object-fit: contain;
  opacity: 0;
  transform: scale(1.05);
  transition: opacity 1s ease, transform 1s ease;
}

.slide.activa {
  opacity: 1;
  transform: scale(1);
}

#texto {
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  text-align: center;
  font-size: 28px;
  color: #fff;
  text-shadow: 0 2px 12px #000;
  display: none;
}

#inicio {
  position: absolute;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
}

#qr-grande {
  width: 360px;
}

#branding {
  position: absolute;
  top: 30px;
  left: 50%;
  transform: translateX(-50%);
}

#branding img {
  width: 180px;
}

#branding.mini {
  top: auto;
  bottom: 20px;
  right: 20px;
  left: auto;
  transform: none;
}

#branding.mini img {
  width: 120px;
}

#qr-mini {
  display: none;
}

#qr-texto {
  position: absolute;
  bottom: 150px;
  right: 20px;
  color: #fff;
  font-size: 18px;
  font-weight: 600;
  text-align: right;
  display: none;
}
</style>
</head>

<body>

<div id="escenario"></div>

<div id="inicio">
  <img id="qr-grande" src="qr.png" alt="QR">
</div>

<div id="branding">
  <img src="logo.png" alt="Logo">
</div>

<div id="qr-mini">
  <img src="qr.png" width="140">
</div>

<div id="qr-texto">ðŸ“¸ EscaneÃ¡ y subÃ­ tu foto</div>

<div id="texto"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://mjmbvzvirvtsihtyrqqf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qbWJ2enZpcnZ0c2lodHlycXFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NDk2ODUsImV4cCI6MjA4NTIyNTY4NX0.ZHo3Tsi2GwJFvW3iwOKBQ6c_6KhHx2Ju8wUrU223zkU"
);

const escenario = document.getElementById("escenario");
const texto = document.getElementById("texto");
const inicio = document.getElementById("inicio");
const branding = document.getElementById("branding");
const qrTexto = document.getElementById("qr-texto");

let fotos = [];
let indice = 0;
let ultimaCantidad = 0;
let mostrandoQR = true;

// ðŸ” Buscar fotos
async function buscarFotos() {
  const { data } = await supabase
    .storage
    .from("evento")
    .list("", {
      limit: 100,
      sortBy: { column: "created_at", order: "desc" }
    });

  if (!data) return;

  const nuevas = data.filter(f =>
    f.name.match(/\.(jpg|jpeg|png|webp)$/i)
  );

  if (nuevas.length > ultimaCantidad) {
    fotos = nuevas;
    indice = 0;
  }

  ultimaCantidad = nuevas.length;
}

// ðŸ–¼ Mostrar foto
function mostrarFoto() {
  if (fotos.length === 0) {
    mostrarQR();
    return;
  }

  ocultarQR();
  escenario.innerHTML = "";

  const f = fotos[indice];
  const { data } = supabase
    .storage
    .from("evento")
    .getPublicUrl(f.name);

  const img = document.createElement("img");
  img.src = data.publicUrl;
  img.className = "slide";
  escenario.appendChild(img);

  requestAnimationFrame(() => {
    img.classList.add("activa");
  });

  const partes = f.name.split("___");
  const nombre = partes[0]?.replace(/_/g, " ");
  const mensaje = partes[1]?.replace(/_/g, " ");

  texto.innerHTML = `<strong>${nombre}</strong><br>${mensaje || ""}`;
  texto.style.display = "block";

  indice = (indice + 1) % fotos.length;
}

// ðŸ“± QR
function mostrarQR() {
  if (mostrandoQR) return;

  escenario.innerHTML = "";
  texto.style.display = "none";

  inicio.style.display = "flex";
  branding.classList.add("mini");
  qrTexto.style.display = "block";

  mostrandoQR = true;
}

function ocultarQR() {
  if (!mostrandoQR) return;

  inicio.style.display = "none";
  branding.classList.add("mini");
  qrTexto.style.display = "none";

  mostrandoQR = false;
}

// â± Loop visual
function loopVisual() {
  if (fotos.length > 0) {
    mostrarFoto();
  } else {
    mostrarQR();
  }
  setTimeout(loopVisual, 5000);
}

// ðŸ”„ Buscar nuevas fotos cada 10s
setInterval(buscarFotos, 10000);

// ðŸš€ Inicio
(async () => {
  await buscarFotos();
  loopVisual();
})();
</script>

</body>
</html>
